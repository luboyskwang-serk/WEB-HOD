# Dedazen Store - เอกสารทางเทคนิค

## ภาพรวมของโครงการ
นี่คือแพลตฟอร์ม e-commerce ที่สร้างด้วย PHP สำหรับขายสินค้าดิจิทัล ส่วนใหญ่เป็นบัญชีเกมและบริการดิจิทัล ระบบมีการจัดการผู้ใช้ แคตตาล็อกสินค้า การประมวลผลการชำระเงิน และการจัดส่งคำสั่งซื้อ

## สแต็กเทคโนโลยี
- **Backend**: PHP 8+ พร้อม PDO สำหรับเข้าถึงฐานข้อมูล
- **Database**: MySQL/MariaDB
- **Frontend**: HTML5, CSS3, JavaScript, Bootstrap 5, jQuery
- **Security**: reCAPTCHA v2, การตรวจสอบสิทธิ์แบบ Session
- **Payment Integration**: Truemoney Wallet API, ระบบการชำระเงินด้วย QR

## โครงสร้างโครงการ
```
htdocs/
├── assets/              # สินทรัพย์คงที่ (รูปภาพ, CSS, JS)
├── auth/                # การรวมระบบการตรวจสอบสิทธิ์ (Discord, Line)
├── dz/                  # สินทรัพย์และรูปภาพที่กำหนดเอง
├── include/             # ส่วนประกอบที่ใช้ร่วมกัน
├── page/                # เทมเพลตหน้าเว็บ
├── system/              # ฟังก์ชันการทำงานหลักด้าน backend
├── index.php            # จุดเข้าสู่ระบบหลัก
├── data.php             # การกำหนดค่า
└── kakarotc_demo.sql    # สคีมาฐานข้อมูล
```

## สคีมาฐานข้อมูล

### ตารางผู้ใช้ (`users`)
เก็บข้อมูลบัญชีผู้ใช้:
- `id` (int, primary): ตัวระบุผู้ใช้เฉพาะ
- `username` (varchar): ชื่อเข้าสู่ระบบของผู้ใช้
- `password` (varchar): รหัสผ่านที่แฮชแบบ MD5 (ปัญหาด้านความปลอดภัย)
- `email` (varchar): ที่อยู่อีเมลของผู้ใช้
- `point` (float): ยอดเงินคงเหลือของผู้ใช้
- `total` (float): จำนวนเงินทั้งหมดที่ผู้ใช้เติมเข้าระบบ
- `rank` (int): บทบาทของผู้ใช้ (0=ผู้ใช้, 1=ผู้ดูแลระบบ)
- `profile` (text): URL ไปยังรูปโปรไฟล์
- `date` (date): วันที่ลงทะเบียน

### ตารางสินค้า (`box_product`)
เก็บข้อมูลสินค้า:
- `id` (int, primary): ตัวระบุสินค้า
- `name` (varchar): ชื่อสินค้า
- `price` (int): ราคาปกติ
- `price_vip` (int): ราคาส่วนลดสำหรับผู้ใช้ VIP
- `des` (varchar): คำอธิบายสินค้า
- `img` (varchar): URL รูปภาพสินค้า
- `type` (int): ประเภทสินค้า (0=สุ่ม, 1=สต็อก)
- `percent` (int): อัตราความสำเร็จสำหรับสินค้าแบบสุ่ม
- `salt_prize` (varchar): ของขวัญสำหรับการจับฉลากที่ไม่ได้รางวัล
- `c_type` (varchar): ประเภทหมวดหมู่

### ตารางสต็อก (`box_stock`)
เก็บสต็อก/สินค้าคงคลัง:
- `id` (int, primary): ตัวระบุรายการสต็อก
- `username` (varchar): ชื่อผู้ใช้บัญชีหรือรายละเอียดรายการ
- `password` (int): รหัสผ่านบัญชีหรือรายละเอียดรายการ
- `p_id` (varchar): การอ้างอิง ID สินค้า

### ประวัติคำสั่งซื้อ (`boxlog`)
บันทึกการซื้อของผู้ใช้ทั้งหมด:
- `id` (int, primary): ตัวระบุคำสั่งซื้อ
- `date` (datetime): ประทับเวลาการซื้อ
- `username` (varchar): ผู้ใช้ที่ทำการซื้อ
- `category` (varchar): หมวดหมู่สินค้า
- `price` (int): ราคาที่จ่าย
- `prize_name` (varchar): รายการที่ได้รับ
- `rand` (int): ประเภทผลลัพธ์ (0=สำเร็จ, 1=ไม่ได้รางวัล, 2=สุ่ม)
- `uid` (varchar): การอ้างอิง ID ผู้ใช้
- `uimg` (text): รูปโปรไฟล์ผู้ใช้

### การตั้งค่า (`setting`)
การกำหนดค่าเว็บไซต์ทั่วไป:
- `name` (varchar): ชื่อเว็บไซต์
- `logo` (varchar): URL รูปโลโก้
- `bg` (varchar): URL รูปพื้นหลัง
- `main_color` (varchar): โทนสีหลัก
- `sec_color` (varchar): โทนสีรอง
- `wallet` (varchar): หมายเลขวอลเล็ต Truemoney
- `discord` (varchar): URL Discord
- `fb` (varchar): URL Facebook
- `lined` (varchar): ID Line

## ฟังก์ชันการทำงานหลัก

### ระบบการตรวจสอบสิทธิ์
ตั้งอยู่ใน `system/a_func.php`:
- การตรวจสอบสิทธิ์แบบ Session
- การจัดการการเชื่อมต่อฐานข้อมูล
- ฟังก์ชันช่วยเหลือสำหรับการ query (`dd_q`)
- การตรวจสอบสิทธิ์ผู้ใช้

### การลงทะเบียนผู้ใช้ (`system/register.php`)
1. ตรวจสอบ reCAPTCHA
2. ตรวจสอบชื่อผู้ใช้ซ้ำ
3. สร้างบันทึกผู้ใช้ใหม่
4. ลงชื่อเข้าระบบอัตโนมัติ
5. รองรับการตรวจสอบอีเมล

### การเข้าสู่ระบบผู้ใช้ (`system/login.php`)
1. ตรวจสอบชื่อผู้ใช้/รหัสผ่าน
2. รองรับการแฮชทั้ง MD5 และ SHA256
3. ตั้งค่าตัวแปร session
4. เปลี่ยนเส้นทางไปยังหน้าแรกเมื่อสำเร็จ

### การเรียกดูสินค้า (`page/shop.php`)
1. แสดงสินค้าตามหมวดหมู่
2. แสดงความพร้อมของสินค้า
3. แสดงราคา (ปกติ/VIP)
4. ฟังก์ชันค้นหา

### การซื้อสินค้า (`system/buybox.php`)
1. ตรวจสอบยอดเงินของผู้ใช้
2. ตรวจสอบความพร้อมของสินค้า
3. ประมวลผลการซื้อตามประเภทสินค้า:
   - ประเภท 0: ระบบจับฉลาก
   - ประเภท 1: การจัดสรรสต็อกโดยตรง
4. อัปเดทยอดเงินผู้ใช้
5. บันทึกธุรกรรมใน `boxlog`
6. ส่งการแจ้งเตือนผ่าน webhook ของ Discord

### การประมวลผลการชำระเงิน (`system/topup.php`)
1. รวมเข้ากับ API ของ Truemoney Wallet ภายนอก
2. ตรวจสอบลิงก์บัตรของขวัญ
3. เครดิตบัญชีผู้ใช้
4. บันทึกธุรกรรมใน `topup_his`
5. ส่งการแจ้งเตือนผ่าน Line

### การจัดการโปรไฟล์ (`page/cimg.php`, `system/changeimg.php`, `system/changepass.php`)
1. อัปเดตรูปโปรไฟล์ผ่าน URL
2. ฟังก์ชันเปลี่ยนรหัสผ่าน
3. ดูประวัติการซื้อ
4. ดูยอดเงินและสถิติบัญชี

## การรวม API

### Truemoney Wallet
- ปลายทาง: บริการ API ภายนอก
- ฟังก์ชัน: ประมวลผลการชำระเงินบัตรของขวัญ
- ความปลอดภัย: การตรวจสอบหมายเลขโทรศัพท์

### Webhooks ของ Discord
- ฟังก์ชัน: ส่งการแจ้งเตือนการซื้อ
- การกำหนดค่า: `setting.webhook_dc`

### reCAPTCHA v2
- ฟังก์ชัน: ป้องกันการลงทะเบียนของบอท
- คีย์เก็บไว้ใน `a_func.php`

## พิจารณาด้านความปลอดภัย

### ปัญหาปัจจุบัน
1. **การแฮชรหัสผ่าน**: ใช้ MD5 ซึ่งถูกทำลายทางวัฒนธรรม
2. **การจัดการ Session**: การใช้งานพื้นฐานโดยไม่มีการหมดเวลา
3. **การตรวจสอบข้อมูล**: บางปลายทางขาดการตรวจสอบอย่างละเอียด

### การปรับปรุงที่แนะนำ
1. โยกย้ายไปใช้ bcrypt หรือ Argon2 สำหรับการแฮชรหัสผ่าน
2. ใช้งานการหมดเวลาและการสร้าง session ใหม่
3. เพิ่มโทเค็นป้องกัน CSRF
4. ใช้งานการจำกัดอัตราสำหรับปลายทาง API

## มาตรฐานโค้ด

### มาตรฐานการเขียน PHP
- ใช้ PDO สำหรับการดำเนินการฐานข้อมูล
- คำสั่งที่เตรียมไว้สำหรับการ query ทั้งหมด
- ฟังก์ชันมีคำนำหน้า `dd_`
- การจัดการข้อผิดพลาดด้วยฟังก์ชัน `dd_return()`

### มาตรฐาน JavaScript
- jQuery สำหรับการจัดการ DOM
- AJAX สำหรับการดำเนินการแบบอะซิงโครนัส
- การจัดการข้อผิดพลาดอย่างสม่ำเสมอด้วย SweetAlert

### มาตรฐาน CSS
- เฟรมเวิร์ก Bootstrap 5
- ตัวแปร CSS ที่กำหนดเองสำหรับการจัดธีม
- หลักการออกแบบที่ตอบสนอง

## พิจารณาการปรับใช้

### ข้อกำหนดของเซิร์ฟเวอร์
- PHP 7.4+ พร้อมส่วนขยาย PDO
- MySQL 5.7+ หรือ MariaDB 10.3+
- เว็บเซิร์ฟเวอร์ Apache หรือ Nginx
- ใบรับรอง SSL สำหรับการเชื่อมต่อที่ปลอดภัย
- สิทธิ์การเขียนสำหรับไดเรกทอรีที่จำเป็น

### ไฟล์การกำหนดค่า
- `system/a_func.php`: การตั้งค่าการเชื่อมต่อฐานข้อมูล
- `data.php`: การกำหนดค่าเพิ่มเติม
- ฐานข้อมูล: ตาราง `setting` สำหรับการกำหนดค่าแบบรันไทม์

### การบำรุงรักษา
- การสำรองข้อมูลฐานข้อมูลเป็นประจำ
- การตรวจสอบไฟล์ log
- การอัปเดตความปลอดภัยสำหรับการพึ่งพา
- การตรวจสอบประสิทธิภาพ

## งานพัฒนาทั่วไป

### การเพิ่มประเภทสินค้าใหม่
1. แก้ไขสคีมาตาราง `box_product` หากจำเป็น
2. อัปเดตตรรกะการซื้อใน `system/buybox.php`
3. สร้างเทมเพลตหน้าใหม่ในไดเรกทอรี `page/`
4. อัปเดตการนำทางใน `index.php`

### การเพิ่มวิธีการชำระเงิน
1. สร้างตัวจัดการใหม่ในไดเรกทอรี `system/`
2. เพิ่มองค์ประกอบ UI ใหม่ใน `page/topup.php`
3. อัปเดตตรรกะการประมวลผลการชำระเงิน
4. กำหนดค่าข้อมูลรับรอง API ใหม่ในฐานข้อมูล

### การแก้ไขบทบาทผู้ใช้
1. อัปเดตตรรกะฟิลด์ `rank` ในฐานข้อมูล
2. แก้ไขการตรวจสอบผู้ดูแลระบบในเทมเพลตหน้า
3. อัปเดตการตรวจสอบสิทธิ์ในฟังก์ชันระบบ

## คู่มือการแก้ปัญหา

### ปัญหาทั่วไป
1. **การล้มเหลวในการเข้าสู่ระบบ**: ตรวจสอบวิธีการแฮชรหัสผ่าน
2. **ข้อผิดพลาดในการประมวลผลการชำระเงิน**: ตรวจสอบข้อมูลรับรอง API
3. **การเชื่อมต่อฐานข้อมูล**: ตรวจสอบการกำหนดค่า `a_func.php`
4. **การโหลดรูปภาพ**: ตรวจสอบสิทธิ์ไฟล์และเส้นทาง

### ไฟล์ log
- ไฟล์ log ข้อผิดพลาดของ PHP
- ไฟล์ log ข้อผิดพลาดของเว็บเซิร์ฟเวอร์
- การบันทึกเฉพาะแอปพลิเคชันในตารางฐานข้อมูล

## โอกาสในการพัฒนาในอนาคต

1. **แอปมือถือ**: แอปพลิเคชันมือถือดั้งเดิม
2. **เลเยอร์ API**: RESTful API สำหรับการรวมภายนอก
3. **แดชบอร์ด Analytics**: ฟีเจอร์ Business Intelligence
4. **ระบบหลายภาษา**: การแปลเพื่อการใช้งานระหว่างประเทศ
5. **สินค้าคงคลังขั้นสูง**: การจัดการสต็อกแบบเรียลไทม์
6. **ระบบการสมัครสมาชิก**: ฟีเจอร์การเรียกเก็บเงินแบบประจำ